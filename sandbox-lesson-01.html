<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pytest Sandbox - Lesson 01</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #f5f5f5;
            padding: 15px;
        }

        .warning-box {
            background: #fff3cd;
            border-left: 4px solid #ff9800;
            padding: 12px 15px;
            margin-bottom: 15px;
            border-radius: 4px;
            font-size: 14px;
        }

        .sandbox-container {
            background: #1e1e1e;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 4px 12px rgba(0,0,0,0.2);
        }

        .sandbox-header {
            background: #2d2d2d;
            padding: 10px 15px;
            color: white;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .sandbox-title {
            font-weight: bold;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .run-button {
            background: #4caf50;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s;
            font-weight: bold;
        }

        .run-button:hover {
            background: #45a049;
        }

        .run-button:active {
            background: #3d8b40;
        }

        .run-button:disabled {
            background: #666;
            cursor: not-allowed;
        }

        #editor {
            height: 320px;
            width: 100%;
        }

        #output {
            background: #1e1e1e;
            color: #d4d4d4;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 13px;
            min-height: 150px;
            max-height: 300px;
            overflow-y: auto;
            white-space: pre-wrap;
            border-top: 1px solid #444;
        }

        .output-success {
            color: #4caf50;
        }

        .output-error {
            color: #f44336;
        }

        .output-info {
            color: #2196F3;
        }

        .loading {
            text-align: center;
            color: #999;
        }

        .hint-box {
            background: #e8f5e9;
            border-left: 4px solid #4caf50;
            padding: 12px 15px;
            margin-top: 15px;
            border-radius: 4px;
            font-size: 13px;
        }

        .hint-box strong {
            display: block;
            margin-bottom: 8px;
        }

        .hint-box ul {
            margin-left: 20px;
        }

        .hint-box li {
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="warning-box">
        üéØ <strong>–¢–≤–æ—è –∑–∞–¥–∞—á–∞:</strong> –ó–∞–ø—É—Å—Ç–∏ –∫–æ–¥ –Ω–∏–∂–µ –∏ –ø–æ—Å–º–æ—Ç—Ä–∏ –∫–∞–∫ pytest –ø–æ–∫–∞–∑—ã–≤–∞–µ—Ç —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã. –ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å –∑–Ω–∞—á–µ–Ω–∏—è –∏ –ø–æ—Å–º–æ—Ç—Ä–µ—Ç—å —á—Ç–æ –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç!
    </div>

    <div class="sandbox-container">
        <div class="sandbox-header">
            <span class="sandbox-title">
                üêç Python + Pytest Sandbox
                <span id="status" style="font-size: 12px; color: #999;"></span>
            </span>
            <button class="run-button" id="runBtn" onclick="runPytest()" disabled>
                ‚è≥ –ó–∞–≥—Ä—É–∑–∫–∞ Python...
            </button>
        </div>
        <div id="editor"># –§—É–Ω–∫—Ü–∏—è –¥–ª—è —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è
def add(a, b):
    return a + b

# –¢–µ—Å—Ç 1: –£—Å–ø–µ—à–Ω—ã–π —Ç–µ—Å—Ç
def test_add_positive():
    result = add(2, 3)
    assert result == 5, "2 + 3 –¥–æ–ª–∂–Ω–æ –±—ã—Ç—å 5"

# –¢–µ—Å—Ç 2: –°–ø–µ—Ü–∏–∞–ª—å–Ω–æ –ø–∞–¥–∞—é—â–∏–π —Ç–µ—Å—Ç (–∏—Å–ø—Ä–∞–≤—å –µ–≥–æ!)
def test_add_negative():
    result = add(-1, -1)
    assert result == -2, "–ò—Å–ø—Ä–∞–≤—å —ç—Ç–æ—Ç assert!"

# –¢–µ—Å—Ç 3: –ü–æ–ø—Ä–æ–±—É–π –¥–æ–±–∞–≤–∏—Ç—å —Å–≤–æ–π —Ç–µ—Å—Ç –∑–¥–µ—Å—å!
</div>
        <div id="output" class="loading">‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ (Pyodide)... ~10 —Å–µ–∫—É–Ω–¥ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –∑–∞–ø—É—Å–∫–µ.</div>
    </div>

    <div class="hint-box">
        <strong>üí° –ü–æ–¥—Å–∫–∞–∑–∫–∏:</strong>
        <ul>
            <li>–ü–æ–ø—Ä–æ–±—É–π –∏–∑–º–µ–Ω–∏—Ç—å <code>assert result == 5</code> –Ω–∞ –¥—Ä—É–≥–æ–µ —á–∏—Å–ª–æ ‚Äî —Ç–µ—Å—Ç —É–ø–∞–¥–µ—Ç!</li>
            <li>–ò—Å–ø—Ä–∞–≤—å <code>test_add_negative</code> —á—Ç–æ–±—ã –æ–Ω –ø—Ä–æ—à–µ–ª (–ø–æ–¥—Å–∫–∞–∑–∫–∞: -1 + -1 = ?)</li>
            <li>–î–æ–±–∞–≤—å —Å–≤–æ–π —Ç–µ—Å—Ç –¥–ª—è —É–º–Ω–æ–∂–µ–Ω–∏—è: <code>def test_multiply(): ...</code></li>
        </ul>
    </div>

    <!-- Monaco Editor -->
    <script src="https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs/loader.js"></script>
    <!-- Pyodide -->
    <script src="https://cdn.jsdelivr.net/pyodide/v0.24.1/full/pyodide.js"></script>

    <script>
        let editor;
        let pyodide;
        let pyodideReady = false;

        // Initialize Monaco Editor
        require.config({ paths: { vs: 'https://cdn.jsdelivr.net/npm/monaco-editor@0.45.0/min/vs' } });

        require(['vs/editor/editor.main'], function() {
            editor = monaco.editor.create(document.getElementById('editor'), {
                value: document.getElementById('editor').textContent,
                language: 'python',
                theme: 'vs-dark',
                fontSize: 13,
                minimap: { enabled: false },
                scrollBeyondLastLine: false,
                automaticLayout: true,
                lineNumbers: 'on',
                folding: false,
                renderLineHighlight: 'all'
            });
        });

        // Initialize Pyodide
        async function loadPyodide() {
            const output = document.getElementById('output');
            const runBtn = document.getElementById('runBtn');
            const status = document.getElementById('status');

            try {
                output.textContent = '‚è≥ –ó–∞–≥—Ä—É–∂–∞–µ–º Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ...';
                status.textContent = '(–∑–∞–≥—Ä—É–∑–∫–∞...)';

                pyodide = await loadPyodide();

                output.textContent = '‚è≥ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º pytest...';
                status.textContent = '(—É—Å—Ç–∞–Ω–æ–≤–∫–∞ pytest...)';

                await pyodide.loadPackage('micropip');
                await pyodide.runPythonAsync(`
                    import micropip
                    await micropip.install('pytest')
                `);

                pyodideReady = true;
                output.innerHTML = '<span class="output-success">‚úÖ Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ! –ù–∞–∂–º–∏ "‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å Pytest"</span>';
                runBtn.disabled = false;
                runBtn.textContent = '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å Pytest';
                status.textContent = '(–≥–æ—Ç–æ–≤–æ)';
            } catch (error) {
                output.innerHTML = '<span class="output-error">‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏: ' + error + '</span>';
                runBtn.textContent = '‚ùå –û—à–∏–±–∫–∞';
                status.textContent = '(–æ—à–∏–±–∫–∞)';
            }
        }

        // Run pytest
        async function runPytest() {
            const output = document.getElementById('output');
            const runBtn = document.getElementById('runBtn');

            if (!pyodideReady) {
                output.innerHTML = '<span class="output-error">‚è≥ –ü–æ–¥–æ–∂–¥–∏—Ç–µ, Python –æ–∫—Ä—É–∂–µ–Ω–∏–µ –µ—â–µ –∑–∞–≥—Ä—É–∂–∞–µ—Ç—Å—è...</span>';
                return;
            }

            const code = editor.getValue();
            output.innerHTML = '<span class="output-info">üöÄ –ó–∞–ø—É—Å–∫–∞–µ–º —Ç–µ—Å—Ç—ã...</span>\n';
            runBtn.disabled = true;
            runBtn.textContent = '‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è...';

            try {
                const result = await pyodide.runPythonAsync(`
import sys
from io import StringIO
import pytest

# Write code to file
with open('/tmp/test_code.py', 'w') as f:
    f.write("""${code.replace(/"/g, '\\"').replace(/\n/g, '\\n')}""")

# Capture output
old_stdout = sys.stdout
old_stderr = sys.stderr
sys.stdout = StringIO()
sys.stderr = StringIO()

# Run pytest
try:
    exit_code = pytest.main(['/tmp/test_code.py', '-v', '--tb=short', '--no-header'])
except Exception as e:
    sys.stderr.write(str(e))

# Get output
output = sys.stdout.getvalue()
errors = sys.stderr.getvalue()
sys.stdout = old_stdout
sys.stderr = old_stderr

output if output else errors
                `);

                // Format output
                const lines = result.split('\n');
                let formattedOutput = '';
                let passedCount = 0;
                let failedCount = 0;

                lines.forEach(line => {
                    if (line.includes('PASSED')) {
                        passedCount++;
                        formattedOutput += '<span class="output-success">‚úÖ ' + line + '</span>\n';
                    } else if (line.includes('FAILED')) {
                        failedCount++;
                        formattedOutput += '<span class="output-error">‚ùå ' + line + '</span>\n';
                    } else if (line.includes('AssertionError') || line.includes('assert')) {
                        formattedOutput += '<span class="output-error">   ' + line + '</span>\n';
                    } else if (line.includes('===') || line.includes('---')) {
                        formattedOutput += '<span class="output-info">' + line + '</span>\n';
                    } else if (line.trim()) {
                        formattedOutput += line + '\n';
                    }
                });

                // Summary
                const total = passedCount + failedCount;
                if (total > 0) {
                    formattedOutput += '\n<span class="output-info">‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ</span>\n';
                    formattedOutput += `<span class="output-info">üìä –ò—Ç–æ–≥–æ: ${total} —Ç–µ—Å—Ç–æ–≤ | </span>`;
                    if (passedCount > 0) formattedOutput += `<span class="output-success">‚úÖ ${passedCount} passed</span>`;
                    if (passedCount > 0 && failedCount > 0) formattedOutput += ' | ';
                    if (failedCount > 0) formattedOutput += `<span class="output-error">‚ùå ${failedCount} failed</span>`;
                }

                output.innerHTML = formattedOutput || '<span class="output-success">‚úÖ –í—Å–µ —Ç–µ—Å—Ç—ã –ø—Ä–æ—à–ª–∏ —É—Å–ø–µ—à–Ω–æ!</span>';

            } catch (error) {
                output.innerHTML = '<span class="output-error">‚ùå –û—à–∏–±–∫–∞ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è:\n' + error + '</span>';
            } finally {
                runBtn.disabled = false;
                runBtn.textContent = '‚ñ∂Ô∏è –ó–∞–ø—É—Å—Ç–∏—Ç—å Pytest';
            }
        }

        // Load on page load
        loadPyodide();
    </script>
</body>
</html>
